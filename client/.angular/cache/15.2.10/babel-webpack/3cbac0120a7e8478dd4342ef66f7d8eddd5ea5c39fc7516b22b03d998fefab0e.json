{"ast":null,"code":"import _asyncToGenerator from \"D:/\\u041B\\u0430\\u0431\\u043A\\u0438/VideoChat/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { Subject } from \"rxjs\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"./signalr.service\";\nexport class RtcService {\n  constructor(_signalR) {\n    this._signalR = _signalR;\n    this._peerConnectionConfig = {\n      iceServers: [{\n        urls: \"stun:stun.services.mozilla.com\"\n      }, {\n        urls: \"stun:stun.l.google.com:19302\"\n      }, {\n        urls: \"stun:stun.awt.be:3478\"\n      }, {\n        urls: \"stun:stun.b2b2c.ca:3478\"\n      }, {\n        urls: \"stun:stun.bahnhof.net:3478\"\n      }, {\n        urls: \"stun:stun.barracuda.com:3478\"\n      }, {\n        urls: \"stun:stun.bluesip.net:3478\"\n      }, {\n        urls: \"stun:stun.bmwgs.cz:3478\"\n      }, {\n        urls: \"stun:stun.botonakis.com:3478\"\n      }, {\n        urls: \"stun:stun.budgetphone.nl:3478\"\n      }, {\n        urls: \"stun:stun.cablenet-as.net:3478\"\n      }]\n    };\n    this._onIceCandidate = new Subject();\n    this.onIceCandidate$ = this._onIceCandidate.asObservable();\n    this._onNegotiationNeeded = new Subject();\n    this.onNegotiationNeeded$ = this._onNegotiationNeeded.asObservable();\n  }\n  createPeer(stream, outputStream, userSrcId, userDestId) {\n    let peer = new RTCPeerConnection(this._peerConnectionConfig);\n    stream.getTracks().forEach(track => {\n      peer.addTrack(track, stream);\n    });\n    peer.onicecandidate = event => {\n      if (event.candidate != null) {\n        this._signalR.sendSignal(userSrcId, userDestId, JSON.stringify({\n          \"ice\": event.candidate\n        }));\n      }\n    };\n    peer.onnegotiationneeded = event => {\n      this._onNegotiationNeeded.next(userDestId);\n    };\n    peer.ontrack = event => {\n      event.streams[0].getTracks().forEach(track => {\n        outputStream.addTrack(track);\n      });\n    };\n    return peer;\n  }\n  getVideoStream() {\n    return _asyncToGenerator(function* () {\n      return yield navigator.mediaDevices.getUserMedia({\n        video: {\n          width: {\n            max: 800\n          },\n          height: {\n            max: 600\n          }\n        },\n        audio: false\n      });\n    })();\n  }\n  getMediaStream() {\n    return _asyncToGenerator(function* () {\n      let stream = yield navigator.mediaDevices.getUserMedia({\n        video: true,\n        audio: true\n      });\n      stream.getAudioTracks().forEach(track => track.stop());\n      return stream;\n    })();\n  }\n  static #_ = this.ɵfac = function RtcService_Factory(t) {\n    return new (t || RtcService)(i0.ɵɵinject(i1.SignalRService));\n  };\n  static #_2 = this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: RtcService,\n    factory: RtcService.ɵfac,\n    providedIn: \"root\"\n  });\n}","map":{"version":3,"mappings":";AACA,SAASA,OAAO,QAAQ,MAAM;;;AAI9B,OAAM,MAAOC,UAAU;EAuBrBC,YAA6BC,QAAwB;IAAxB,aAAQ,GAARA,QAAQ;IAtBpB,0BAAqB,GAAI;MACxCC,UAAU,EAAE,CACV;QAAEC,IAAI,EAAE;MAAgC,CAAE,EAC1C;QAAEA,IAAI,EAAE;MAA8B,CAAE,EACxC;QAAEA,IAAI,EAAE;MAAuB,CAAE,EACjC;QAAEA,IAAI,EAAE;MAAyB,CAAE,EACnC;QAAEA,IAAI,EAAE;MAA4B,CAAE,EACtC;QAAEA,IAAI,EAAE;MAA8B,CAAE,EACxC;QAAEA,IAAI,EAAE;MAA4B,CAAE,EACtC;QAAEA,IAAI,EAAE;MAAyB,CAAE,EACnC;QAAEA,IAAI,EAAE;MAA8B,CAAE,EACxC;QAAEA,IAAI,EAAE;MAA+B,CAAE,EACzC;QAAEA,IAAI,EAAE;MAAgC,CAAE;KAE7C;IAEO,oBAAe,GAAG,IAAIL,OAAO,EAA6B;IAC3D,oBAAe,GAAG,IAAI,CAACM,eAAe,CAACC,YAAY,EAAE;IAEpD,yBAAoB,GAAG,IAAIP,OAAO,EAAU;IAC7C,yBAAoB,GAAG,IAAI,CAACQ,oBAAoB,CAACD,YAAY,EAAE;EAEd;EAEjDE,UAAU,CAACC,MAAmB,EAAEC,YAAyB,EAAEC,SAAiB,EAAEC,UAAkB;IACrG,IAAIC,IAAI,GAAG,IAAIC,iBAAiB,CAAC,IAAI,CAACC,qBAAqB,CAAC;IAC5DN,MAAM,CAACO,SAAS,EAAE,CAACC,OAAO,CAAEC,KAAK,IAAI;MACnCL,IAAI,CAACM,QAAQ,CAACD,KAAK,EAAET,MAAM,CAAC;IAC9B,CAAC,CAAC;IACFI,IAAI,CAACO,cAAc,GAAIC,KAAK,IAAI;MAC9B,IAAGA,KAAK,CAACC,SAAS,IAAI,IAAI,EAAE;QAC1B,IAAI,CAACpB,QAAQ,CAACqB,UAAU,CAACZ,SAAS,EAAEC,UAAU,EAAEY,IAAI,CAACC,SAAS,CAAC;UAAE,KAAK,EAAEJ,KAAK,CAACC;QAAS,CAAE,CAAC,CAAC;;IAE/F,CAAC;IACDT,IAAI,CAACa,mBAAmB,GAAIL,KAAK,IAAI;MACnC,IAAI,CAACd,oBAAoB,CAACoB,IAAI,CAACf,UAAU,CAAC;IAC5C,CAAC;IACDC,IAAI,CAACe,OAAO,GAAIP,KAAK,IAAI;MACvBA,KAAK,CAACQ,OAAO,CAAC,CAAC,CAAC,CAACb,SAAS,EAAE,CAACC,OAAO,CAAEC,KAAK,IAAI;QAC7CR,YAAY,CAACS,QAAQ,CAACD,KAAK,CAAC;MAC9B,CAAC,CAAC;IACJ,CAAC;IACD,OAAOL,IAAI;EACb;EAEaiB,cAAc;IAAA;MACzB,aAAaC,SAAS,CAACC,YAAY,CAACC,YAAY,CAAC;QAC/CC,KAAK,EAAE;UACLC,KAAK,EAAE;YAAEC,GAAG,EAAE;UAAG,CAAE;UACnBC,MAAM,EAAE;YAAED,GAAG,EAAE;UAAG;SACnB;QACDE,KAAK,EAAE;OACR,CAAC;IAAC;EACL;EAEaC,cAAc;IAAA;MACzB,IAAI9B,MAAM,SAASsB,SAAS,CAACC,YAAY,CAACC,YAAY,CAAC;QACrDC,KAAK,EAAE,IAAI;QACXI,KAAK,EAAE;OACR,CAAC;MACF7B,MAAM,CAAC+B,cAAc,EAAE,CAACvB,OAAO,CAAEC,KAAK,IAAKA,KAAK,CAACuB,IAAI,EAAE,CAAC;MACxD,OAAOhC,MAAM;IAAC;EAChB;EAAC;qBA/DUT,UAAU;EAAA;EAAA;WAAVA,UAAU;IAAA0C,SAAV1C,UAAU;IAAA2C,YADG;EAAM","names":["Subject","RtcService","constructor","_signalR","iceServers","urls","_onIceCandidate","asObservable","_onNegotiationNeeded","createPeer","stream","outputStream","userSrcId","userDestId","peer","RTCPeerConnection","_peerConnectionConfig","getTracks","forEach","track","addTrack","onicecandidate","event","candidate","sendSignal","JSON","stringify","onnegotiationneeded","next","ontrack","streams","getVideoStream","navigator","mediaDevices","getUserMedia","video","width","max","height","audio","getMediaStream","getAudioTracks","stop","factory","providedIn"],"sourceRoot":"","sources":["D:\\Лабки\\VideoChat\\client\\src\\service\\rtc.service.ts"],"sourcesContent":["import { Injectable } from \"@angular/core\";\r\nimport { Subject } from \"rxjs\";\r\nimport { SignalRService } from \"./signalr.service\";\r\n\r\n@Injectable({ providedIn: \"root\" })\r\nexport class RtcService {\r\n  private readonly _peerConnectionConfig =  {\r\n    iceServers: [\r\n      { urls: \"stun:stun.services.mozilla.com\" },\r\n      { urls: \"stun:stun.l.google.com:19302\" },\r\n      { urls: \"stun:stun.awt.be:3478\" },\r\n      { urls: \"stun:stun.b2b2c.ca:3478\" },\r\n      { urls: \"stun:stun.bahnhof.net:3478\" },\r\n      { urls: \"stun:stun.barracuda.com:3478\" },\r\n      { urls: \"stun:stun.bluesip.net:3478\" },\r\n      { urls: \"stun:stun.bmwgs.cz:3478\" },\r\n      { urls: \"stun:stun.botonakis.com:3478\" },\r\n      { urls: \"stun:stun.budgetphone.nl:3478\" },\r\n      { urls: \"stun:stun.cablenet-as.net:3478\" }\r\n    ]\r\n  };\r\n\r\n  private _onIceCandidate = new Subject<RTCPeerConnectionIceEvent>();\r\n  public onIceCandidate$ = this._onIceCandidate.asObservable();\r\n\r\n  private _onNegotiationNeeded = new Subject<string>();\r\n  public onNegotiationNeeded$ = this._onNegotiationNeeded.asObservable();\r\n\r\n  constructor(private readonly _signalR: SignalRService) {}\r\n\r\n  public createPeer(stream: MediaStream, outputStream: MediaStream, userSrcId: string, userDestId: string): RTCPeerConnection {\r\n    let peer = new RTCPeerConnection(this._peerConnectionConfig);\r\n    stream.getTracks().forEach((track) => {\r\n      peer.addTrack(track, stream);\r\n    });\r\n    peer.onicecandidate = (event) => {\r\n      if(event.candidate != null) {\r\n        this._signalR.sendSignal(userSrcId, userDestId, JSON.stringify({ \"ice\": event.candidate }));\r\n      }\r\n    };\r\n    peer.onnegotiationneeded = (event) => {\r\n      this._onNegotiationNeeded.next(userDestId);\r\n    };\r\n    peer.ontrack = (event) => {\r\n      event.streams[0].getTracks().forEach((track) => {\r\n        outputStream.addTrack(track);\r\n      });\r\n    };\r\n    return peer;\r\n  }\r\n\r\n  public async getVideoStream(): Promise<MediaStream> {\r\n    return await navigator.mediaDevices.getUserMedia({\r\n      video: {\r\n        width: { max: 800 },\r\n        height: { max: 600 }\r\n      },\r\n      audio: false\r\n    });\r\n  }\r\n\r\n  public async getMediaStream(): Promise<MediaStream> {\r\n    let stream = await navigator.mediaDevices.getUserMedia({\r\n      video: true,\r\n      audio: true\r\n    });\r\n    stream.getAudioTracks().forEach((track) => track.stop());\r\n    return stream;\r\n  }\r\n}"]},"metadata":{},"sourceType":"module","externalDependencies":[]}