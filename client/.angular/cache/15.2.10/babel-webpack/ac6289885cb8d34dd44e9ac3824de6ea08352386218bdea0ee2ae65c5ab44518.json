{"ast":null,"code":"import _asyncToGenerator from \"D:/\\u041B\\u0430\\u0431\\u043A\\u0438/VideoChat/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { __decorate } from \"tslib\";\nimport { Component, Input, ViewChild } from '@angular/core';\nimport { Subscription } from 'rxjs';\nlet LocalParticipantComponent = class LocalParticipantComponent {\n  constructor(_signalR) {\n    this._signalR = _signalR;\n    this._subscriptions = new Subscription();\n    this.peerConnection = new RTCPeerConnection();\n    this.isMicroActive = false;\n  }\n  _createOffer() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      _this.peerConnection.onicecandidate = /*#__PURE__*/function () {\n        var _ref = _asyncToGenerator(function* (event) {\n          if (event.candidate) {\n            _this._signalR.sendOffer(_this.participant.id, _this.peerConnection.localDescription);\n          }\n        });\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }();\n      const offer = yield _this.peerConnection.createOffer();\n      yield _this.peerConnection.setLocalDescription(offer);\n    })();\n  }\n  _initOnAnswer() {\n    var _this2 = this;\n    this._signalR.onAnswer$.subscribe( /*#__PURE__*/function () {\n      var _ref2 = _asyncToGenerator(function* (answerEvent) {\n        if (answerEvent.userId !== _this2.participant.id) {\n          return;\n        }\n        let answer = JSON.parse(answerEvent.answerJson);\n        console.log('Add answer triggerd');\n        console.log('answer:', answer);\n        if (!_this2.peerConnection.currentRemoteDescription) {\n          _this2.peerConnection.setRemoteDescription(answer);\n        }\n      });\n      return function (_x2) {\n        return _ref2.apply(this, arguments);\n      };\n    }());\n  }\n  ngOnInit() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      let stream = _this3.participant.stream;\n      stream.getTracks().forEach(track => {\n        _this3.peerConnection.addTrack(track, stream);\n      });\n      _this3._initOnAnswer();\n      yield _this3._createOffer();\n    })();\n  }\n  ngOnDestroy() {\n    this.peerConnection.close();\n    this._subscriptions.unsubscribe();\n  }\n};\n__decorate([ViewChild(\"video\")], LocalParticipantComponent.prototype, \"videoEl\", void 0);\n__decorate([Input()], LocalParticipantComponent.prototype, \"participant\", void 0);\nLocalParticipantComponent = __decorate([Component({\n  selector: 'app-local-participant',\n  templateUrl: './participant.component.html',\n  styleUrls: ['./participant.component.scss']\n})], LocalParticipantComponent);\nexport { LocalParticipantComponent };","map":{"version":3,"mappings":";;AAAA,SAASA,SAAS,EAAcC,KAAK,EAAEC,SAAS,QAAiD,eAAe;AAChH,SAAkBC,YAAY,QAAQ,MAAM;AAYrC,IAAMC,yBAAyB,GAA/B,MAAMA,yBAAyB;EAUpCC,YAA6BC,QAAwB;IAAxB,aAAQ,GAARA,QAAQ;IAN7B,mBAAc,GAAG,IAAIH,YAAY,EAAE;IAEpC,mBAAc,GAAG,IAAII,iBAAiB,EAAE;IAExC,kBAAa,GAAG,KAAK;EAE4B;EAE1CC,YAAY;IAAA;IAAA;MACxB,KAAI,CAACC,cAAc,CAACC,cAAc;QAAA,6BAAG,WAAOC,KAAK,EAAI;UACnD,IAAGA,KAAK,CAACC,SAAS,EAAC;YACjB,KAAI,CAACN,QAAQ,CAACO,SAAS,CAAC,KAAI,CAACC,WAAW,CAACC,EAAE,EAAE,KAAI,CAACN,cAAc,CAACO,gBAAiB,CAAC;;QAEvF,CAAC;QAAA;UAAA;QAAA;MAAA;MACD,MAAMC,KAAK,SAAS,KAAI,CAACR,cAAc,CAACS,WAAW,EAAE;MACrD,MAAM,KAAI,CAACT,cAAc,CAACU,mBAAmB,CAACF,KAAK,CAAC;IAAC;EACvD;EAEQG,aAAa;IAAA;IACnB,IAAI,CAACd,QAAQ,CAACe,SAAS,CAACC,SAAS;MAAA,8BAAC,WAAOC,WAAwB,EAAI;QACnE,IAAIA,WAAW,CAACC,MAAM,KAAK,MAAI,CAACV,WAAW,CAACC,EAAE,EAAE;UAC9C;;QAEF,IAAIU,MAAM,GAAGC,IAAI,CAACC,KAAK,CAACJ,WAAW,CAACK,UAAU,CAA8B;QAC5EC,OAAO,CAACC,GAAG,CAAC,qBAAqB,CAAC;QAClCD,OAAO,CAACC,GAAG,CAAC,SAAS,EAAEL,MAAM,CAAC;QAC9B,IAAI,CAAC,MAAI,CAAChB,cAAc,CAACsB,wBAAwB,EAAC;UAChD,MAAI,CAACtB,cAAc,CAACuB,oBAAoB,CAACP,MAAM,CAAC;;MAEpD,CAAC;MAAA;QAAA;MAAA;IAAA,IAAC;EACJ;EAEaQ,QAAQ;IAAA;IAAA;MACnB,IAAIC,MAAM,GAAG,MAAI,CAACpB,WAAW,CAACoB,MAAM;MACpCA,MAAM,CAACC,SAAS,EAAE,CAACC,OAAO,CAAEC,KAAK,IAAI;QACnC,MAAI,CAAC5B,cAAc,CAAC6B,QAAQ,CAACD,KAAK,EAAEH,MAAM,CAAC;MAC7C,CAAC,CAAC;MACF,MAAI,CAACd,aAAa,EAAE;MACpB,MAAM,MAAI,CAACZ,YAAY,EAAE;IAAC;EAC5B;EAEO+B,WAAW;IAChB,IAAI,CAAC9B,cAAc,CAAC+B,KAAK,EAAE;IAC3B,IAAI,CAACC,cAAc,CAACC,WAAW,EAAE;EACnC;CACD;AAhDqBC,YAAnBzC,SAAS,CAAC,OAAO,CAAC,0DAA8B;AACxCyC,YAAR1C,KAAK,EAAE,8DAAqC;AAFlCG,yBAAyB,eALrCJ,SAAS,CAAC;EACT4C,QAAQ,EAAE,uBAAuB;EACjCC,WAAW,EAAE,8BAA8B;EAC3CC,SAAS,EAAE,CAAC,8BAA8B;CAC3C,CAAC,GACW1C,yBAAyB,CAiDrC;SAjDYA,yBAAyB","names":["Component","Input","ViewChild","Subscription","LocalParticipantComponent","constructor","_signalR","RTCPeerConnection","_createOffer","peerConnection","onicecandidate","event","candidate","sendOffer","participant","id","localDescription","offer","createOffer","setLocalDescription","_initOnAnswer","onAnswer$","subscribe","answerEvent","userId","answer","JSON","parse","answerJson","console","log","currentRemoteDescription","setRemoteDescription","ngOnInit","stream","getTracks","forEach","track","addTrack","ngOnDestroy","close","_subscriptions","unsubscribe","__decorate","selector","templateUrl","styleUrls"],"sourceRoot":"","sources":["D:\\Лабки\\VideoChat\\client\\src\\app\\participant\\local-participant.component.ts"],"sourcesContent":["import { Component, ElementRef, Input, ViewChild, OnInit, OnDestroy, Output, EventEmitter } from '@angular/core';\r\nimport { Subject, Subscription } from 'rxjs';\r\nimport { AnswerEvent } from 'src/model/answer-event';\r\nimport { OfferEvent } from 'src/model/offer-event';\r\nimport { RtcParticipant } from 'src/model/rtc-participant';\r\nimport { SignalRService } from 'src/service/signalr.service';\r\nimport { RtcService } from 'src/service/rtc.service';\r\n\r\n@Component({\r\n  selector: 'app-local-participant',\r\n  templateUrl: './participant.component.html',\r\n  styleUrls: ['./participant.component.scss']\r\n})\r\nexport class LocalParticipantComponent implements OnInit, OnDestroy {\r\n  @ViewChild(\"video\") public videoEl! : ElementRef;\r\n  @Input() public participant!: RtcParticipant;\r\n\r\n  private _subscriptions = new Subscription();\r\n\r\n  public peerConnection = new RTCPeerConnection();\r\n\r\n  public isMicroActive = false;\r\n\r\n  constructor(private readonly _signalR: SignalRService) {}\r\n\r\n  private async _createOffer() {\r\n    this.peerConnection.onicecandidate = async (event) => {\r\n      if(event.candidate){\r\n        this._signalR.sendOffer(this.participant.id, this.peerConnection.localDescription!);\r\n      }\r\n    };\r\n    const offer = await this.peerConnection.createOffer();\r\n    await this.peerConnection.setLocalDescription(offer);\r\n  }\r\n\r\n  private _initOnAnswer() {\r\n    this._signalR.onAnswer$.subscribe(async (answerEvent: AnswerEvent) => {\r\n      if (answerEvent.userId !== this.participant.id) {\r\n        return;\r\n      }\r\n      let answer = JSON.parse(answerEvent.answerJson) as RTCSessionDescriptionInit;\r\n      console.log('Add answer triggerd')\r\n      console.log('answer:', answer)\r\n      if (!this.peerConnection.currentRemoteDescription){\r\n        this.peerConnection.setRemoteDescription(answer);\r\n      }\r\n    });\r\n  }\r\n\r\n  public async ngOnInit() {\r\n    let stream = this.participant.stream;\r\n    stream.getTracks().forEach((track) => {\r\n      this.peerConnection.addTrack(track, stream);\r\n    });\r\n    this._initOnAnswer();\r\n    await this._createOffer();\r\n  }\r\n\r\n  public ngOnDestroy(): void {\r\n    this.peerConnection.close();\r\n    this._subscriptions.unsubscribe();\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}